rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    // ---------------------------------------
    // BUCKETS (query-friendly)
    // ---------------------------------------
    function isBucketMember() {
      return signedIn() && (request.auth.uid in resource.data.memberIds);
    }

    function isBucketOwner() {
      return signedIn() && (resource.data.ownerId == request.auth.uid);
    }

    match /buckets/{bucketId} {

      allow list, get: if isBucketMember() || isBucketOwner();

      allow create: if signedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.memberIds is list
        && request.auth.uid in request.resource.data.memberIds
        && request.resource.data.name is string
        && request.resource.data.target is number
        && request.resource.data.balance is number;

      allow update: if (isBucketMember() || isBucketOwner())
        && request.resource.data.ownerId == resource.data.ownerId
        && (resource.data.ownerId in request.resource.data.memberIds)
        && (
          request.resource.data.memberIds == resource.data.memberIds
          || isBucketOwner()
        );

      allow delete: if isBucketOwner();
    }

    // ---------------------------------------
    // TRIPS (query-friendly)  âœ… NEW
    // ---------------------------------------
    function isTripMember() {
      return signedIn() && (request.auth.uid in resource.data.memberIds);
    }

    function isTripOwner() {
      return signedIn() && (resource.data.ownerId == request.auth.uid);
    }

    match /trips/{tripId} {

      // allow querying trips where memberIds array-contains uid
      allow list, get: if isTripMember() || isTripOwner();

      // Create: must include ownerId/memberIds/title, and caller must be in memberIds
      allow create: if signedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.memberIds is list
        && request.auth.uid in request.resource.data.memberIds
        && request.resource.data.title is string;

      // Update: members can update fields, ONLY owner can change memberIds
      allow update: if (isTripMember() || isTripOwner())
        && request.resource.data.ownerId == resource.data.ownerId
        && (resource.data.ownerId in request.resource.data.memberIds)
        && (
          request.resource.data.memberIds == resource.data.memberIds
          || isTripOwner()
        );

      // Delete: only owner
      allow delete: if isTripOwner();
    }

    // ---------------------------------------
    // USERS
    // ---------------------------------------
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    match /publicUsers/{uid} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == uid;
    }
  }
}
