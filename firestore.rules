rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function hasMemberList() {
      return resource.data.memberIds is list;
    }

    function isMember() {
      return signedIn()
        && hasMemberList()
        && (request.auth.uid in resource.data.memberIds);
    }

    function isOwner() {
      return signedIn()
        && resource.data.ownerId == request.auth.uid;
    }

    // Prevent ownerId changes + ensure owner remains a member after update
    function ownerLockedAndStaysMember() {
      return request.resource.data.ownerId == resource.data.ownerId
        && (request.resource.data.memberIds is list)
        && (resource.data.ownerId in request.resource.data.memberIds);
    }

    match /buckets/{bucketId} {

      // Members can read
      allow read: if isMember();

      // Create: must be signed in, ownerId must be caller, memberIds must exist and include caller
      allow create: if signedIn()
        && (request.resource.data.memberIds is list)
        && (request.resource.data.ownerId == request.auth.uid)
        && (request.auth.uid in request.resource.data.memberIds);

      /**
       * Update:
       * - Must already be a member (so outsiders cannot modify)
       * - ownerId can never change
       * - owner must always remain in memberIds
       * - If memberIds is changing -> ONLY owner can do that
       * - If memberIds is NOT changing -> any member can update other fields
       */
      allow update: if isMember()
        && ownerLockedAndStaysMember()
        && (
          // memberIds unchanged => any member can update other fields
          request.resource.data.memberIds == resource.data.memberIds

          // memberIds changed => only owner can do it
          || isOwner()
        );

      // Delete: only owner
      allow delete: if isOwner();
    }

    // Private user doc (only the owner can read/write their own)
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    /**
     * Public profile doc used for avatars + display names
     * Anyone signed-in can read
     * Only the user can write their own doc
     */
    match /publicUsers/{uid} {
      allow read: if signedIn();
      allow create, update, delete: if signedIn() && request.auth.uid == uid;
    }
  }
}
