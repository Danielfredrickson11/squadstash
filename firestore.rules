rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    // --- Buckets helpers (QUERY FRIENDLY) ---
    // IMPORTANT: no type checks here, so Firestore can prove query safety.
    function isBucketMember() {
      return signedIn() && (request.auth.uid in resource.data.memberIds);
    }

    function isBucketOwner() {
      return signedIn() && (resource.data.ownerId == request.auth.uid);
    }

    // --- Buckets ---
    match /buckets/{bucketId} {

      // ✅ Allow queries that filter by memberIds (array-contains)
      allow list: if isBucketMember() || isBucketOwner();
      allow get:  if isBucketMember() || isBucketOwner();

      // ✅ Create: validate required fields strongly
      allow create: if signedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.memberIds is list
        && request.auth.uid in request.resource.data.memberIds
        && request.resource.data.name is string
        && request.resource.data.target is number
        && request.resource.data.balance is number;

      // ✅ Update: members can update most fields, but ONLY owner can change memberIds
      allow update: if (isBucketMember() || isBucketOwner())
        // ownerId can never change
        && request.resource.data.ownerId == resource.data.ownerId
        // owner must always remain a member
        && (resource.data.ownerId in request.resource.data.memberIds)
        && (
          // memberIds unchanged => any member can update other fields
          request.resource.data.memberIds == resource.data.memberIds
          // memberIds changed => only owner can do it
          || isBucketOwner()
        );

      // ✅ Delete: only owner
      allow delete: if isBucketOwner();
    }

    // --- Private user doc (only you) ---
    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    // --- Public profiles ---
    match /publicUsers/{uid} {
      allow read: if signedIn();
      allow write: if signedIn() && request.auth.uid == uid;
    }
  }
}
